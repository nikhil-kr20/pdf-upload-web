<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= username %> - Uploads</title>
    <link rel="stylesheet" href="/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <section class="user-hero" style="padding:48px 0; background: linear-gradient(135deg,#eff6ff,#f5f3ff);">
        <div class="pdf-list-container" style="width: min(1200px, 100% - 96px); margin: 0 auto;">
            <div style="display:flex; align-items:center; gap:16px;">
                <div class="avatar" style="width:56px; height:56px; border-radius:50%; background:#312e81; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700;">
                    <%= (username || 'U').charAt(0).toUpperCase() %>
                </div>
                <div>
                    <h1 style="margin:0; font-size:1.6rem; color:#0f172a;">Uploads by <span style="color:#4f46e5;"><%= username %></span></h1>
                    <p style="margin:4px 0 0; color:#475569;">All notes shared by this user</p>
                </div>
            </div>
        </div>
    </section>

    <section style="padding: 24px 0; background: url('/hero1.png') center/cover no-repeat;">
        <div class="pdf-list-container" style="width: min(1200px, 100% - 96px); margin: 0 auto;">
            <% if (notes && notes.length) { %>
                <div class="pdf-grid" style="display:grid; grid-template-columns: repeat(3, minmax(260px, 1fr)); gap: 36px;">
                    <% notes.forEach(note => { %>
                        <div class="pdf-card" style="background:#fff; border-radius:18px; padding:16px; box-shadow:0 4px 15px rgba(0,0,0,.08); border:1px solid rgba(15,23,42,.06); text-align:center;">
                            <div class="thumb-wrap" style="border-radius:16px; overflow:hidden; background:#0f172a; margin-bottom:1rem;">
                                <canvas class="thumb-canvas" data-id="<%= note._id %>"></canvas>
                            </div>
                            <h3 style="margin: 8px 0 6px; color:#0f172a; font-weight:700; font-size:1.05rem;"><%= note.title %></h3>
                            <div class="pdf-meta" style="display:flex; justify-content:center; gap:10px; margin:10px 0 14px;">
                                <span class="chip" style="background:#f1f5f9; color:#0f172a; padding:6px 10px; border-radius:999px; font-size:.85rem; display:inline-flex; align-items:center; gap:.5rem;" title="Upload date"><i class="fas fa-calendar-alt"></i><%= new Date(note.uploadedAt || note._id.getTimestamp()).toLocaleDateString() %></span>
                            </div>
                            <div class="pdf-actions" style="display:flex; justify-content:center; gap:.75rem;">
                                <button class="btn btn-primary" style="border-radius:999px; font-weight:800;" onclick="window.location.href='/view/<%= note._id %>'"><i class="fas fa-eye"></i> View</button>
                                <button class="btn btn-secondary" style="border-radius:999px; font-weight:800;" onclick="window.location.href='/download/<%= note._id %>'"><i class="fas fa-download"></i> Download</button>
                            </div>
                        </div>
                    <% }) %>
                </div>
            <% } else { %>
                <div class="empty-state" style="text-align:center; padding:4rem 2rem; background: rgba(255,255,255,.9); backdrop-filter: blur(20px); border-radius:24px; box-shadow:0 20px 40px rgba(0,0,0,.1); border:1px solid rgba(255,255,255,.3); max-width:500px; margin: 0 auto;">
                    <div class="empty-icon" style="font-size:4rem; color:#9ca3af; margin-bottom:1.5rem;">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <h3 style="font-size:1.5rem; font-weight:700; color:#1f2937; margin-bottom:1rem;">No uploads yet</h3>
                    <p style="color:#6b7280;">This user hasn't shared any notes.</p>
                </div>
            <% } %>
        </div>
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        if (window.pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        }
        document.addEventListener('DOMContentLoaded', function() {
            const canvases = document.querySelectorAll('.thumb-canvas');
            canvases.forEach((canvas) => {
                const id = canvas.getAttribute('data-id');
                const url = `/download/${id}`;
                fetch(url)
                  .then(res => { if(!res.ok) throw new Error('Failed'); return res.arrayBuffer(); })
                  .then(data => pdfjsLib.getDocument({ data }).promise)
                  .then(pdf => pdf.getPage(1))
                  .then(page => {
                      const desiredWidth = 320;
                      const viewport1x = page.getViewport({ scale: 1 });
                      const scale = desiredWidth / viewport1x.width;
                      const viewport = page.getViewport({ scale });
                      const off = document.createElement('canvas');
                      off.width = viewport.width;
                      off.height = viewport.height;
                      const offCtx = off.getContext('2d');
                      page.render({ canvasContext: offCtx, viewport }).promise.then(() => {
                          const ctx = canvas.getContext('2d');
                          canvas.width = viewport.width;
                          canvas.height = Math.floor(viewport.height / 2);
                          ctx.drawImage(off, 0, 0, off.width, off.height / 2, 0, 0, canvas.width, canvas.height);
                      });
                  })
                  .catch(() => {
                      canvas.outerHTML = '<div class="thumb-fallback">Preview unavailable</div>';
                  });
            });
        });
    </script>
</body>
</html>

